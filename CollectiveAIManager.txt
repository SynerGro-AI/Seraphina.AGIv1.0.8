import React, { useState, useEffect } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { badgeClasses } from '@/components/ui/badge-span';
import { Button } from '@/components/ui/button';
import { supabase } from '@/lib/supabase';

interface MeshNode {
  id: string;
  type: 'seraphina' | 'guardian' | 'arduino' | 'robot' | 'app';
  appId?: string;
  capabilities: string[];
  lastHeartbeat: number;
}

interface CollectiveLearning {
  id: string;
  source: string;
  data: any;
  timestamp: number;
  learningType: string;
}

export const CollectiveAIManager: React.FC = () => {
  const [meshStatus, setMeshStatus] = useState<any>(null);
  const [isSpawning, setIsSpawning] = useState(false);
  const [learningData, setLearningData] = useState<CollectiveLearning[]>([]);

  const fetchMeshStatus = async () => {
    try {
      const { data } = await supabase.functions.invoke('seraphina-mesh-coordinator', {
        body: { action: 'get_mesh_status' }
      });
      setMeshStatus(data);
      setLearningData(data.recentLearning || []);
    } catch (error) {
      console.error('Error fetching mesh status:', error);
    }
  };

  const spawnNewAppNodes = async () => {
    setIsSpawning(true);
    try {
      const appId = `app-${Date.now()}`;
      const { data } = await supabase.functions.invoke('seraphina-mesh-coordinator', {
        body: { 
          action: 'spawn_new_app_nodes',
          appId 
        }
      });
      console.log('New nodes spawned:', data);
      await fetchMeshStatus();
    } catch (error) {
      console.error('Error spawning nodes:', error);
    }
    setIsSpawning(false);
  };

  const shareCollectiveLearning = async (learningType: string, data: any) => {
    try {
      await supabase.functions.invoke('seraphina-mesh-coordinator', {
        body: {
          action: 'share_learning',
          learningData: {
            source: 'management-system',
            type: learningType,
            data
          }
        }
      });
      await fetchMeshStatus();
    } catch (error) {
      console.error('Error sharing learning:', error);
    }
  };

  useEffect(() => {
    fetchMeshStatus();
    const interval = setInterval(fetchMeshStatus, 5000);
    return () => clearInterval(interval);
  }, []);

  return (
    <div className="space-y-6">
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            üß† Collective AI Brain Management
            <span className={badgeClasses('secondary')}>
              {meshStatus?.totalNodes || 0} Nodes
            </span>
          </CardTitle>
        </CardHeader>
        <CardContent className="space-y-4">
          <div className="grid grid-cols-2 md:grid-cols-5 gap-4">
            <div className="text-center">
              <div className="text-2xl font-bold text-blue-500">
                {meshStatus?.nodeTypes?.seraphina || 0}
              </div>
              <div className="text-sm text-gray-600">Seraphina AI</div>
            </div>
            <div className="text-center">
              <div className="text-2xl font-bold text-green-500">
                {meshStatus?.nodeTypes?.guardian || 0}
              </div>
              <div className="text-sm text-gray-600">Guardian Bots</div>
            </div>
            <div className="text-center">
              <div className="text-2xl font-bold text-orange-500">
                {meshStatus?.nodeTypes?.arduino || 0}
              </div>
              <div className="text-sm text-gray-600">Arduino</div>
            </div>
            <div className="text-center">
              <div className="text-2xl font-bold text-red-500">
                {meshStatus?.nodeTypes?.robot || 0}
              </div>
              <div className="text-sm text-gray-600">Robot Bots</div>
            </div>
            <div className="text-center">
              <div className="text-2xl font-bold text-purple-500">
                {meshStatus?.collectiveKnowledge || 0}
              </div>
              <div className="text-sm text-gray-600">Knowledge Units</div>
            </div>
          </div>

          <Button 
            onClick={spawnNewAppNodes} 
            disabled={isSpawning}
            className="w-full"
          >
            {isSpawning ? 'Spawning...' : 'üöÄ Spawn New App Nodes'}
          </Button>
        </CardContent>
      </Card>

      <Card>
        <CardHeader>
          <CardTitle>üåê Collective Learning Stream</CardTitle>
        </CardHeader>
        <CardContent>
          <div className="space-y-2 max-h-64 overflow-y-auto">
            {learningData.map((learning) => (
              <div key={learning.id} className="flex items-center justify-between p-2 bg-gray-50 rounded">
                <div>
                  <span className={badgeClasses('outline')}>{learning.learningType}</span>
                  <span className="ml-2 text-sm">{learning.source}</span>
                </div>
                <div className="text-xs text-gray-500">
                  {new Date(learning.timestamp).toLocaleTimeString()}
                </div>
              </div>
            ))}
          </div>
        </CardContent>
      </Card>
    </div>
  );
};