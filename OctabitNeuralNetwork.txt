import React, { useState, useEffect } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { badgeClasses } from '@/components/ui/badge-span';
import { Progress } from '@/components/ui/progress';

interface NeuralNode {
  id: number;
  x: number;
  y: number;
  z: number;
  frequency: number;
  connections: number[];
  quantumState: number;
  locked: boolean;
  spiralPosition: number;
}

interface NetworkStats {
  totalNodes: number;
  activeConnections: number;
  quantumLock: number;
  harmonicResonance: number;
  neuralEfficiency: number;
}

export const OctaBitNeuralNetwork: React.FC = () => {
  const [nodes, setNodes] = useState<NeuralNode[]>([]);
  const [stats, setStats] = useState<NetworkStats>({
    totalNodes: 0,
    activeConnections: 0,
    quantumLock: 0,
    harmonicResonance: 0,
    neuralEfficiency: 0
  });
  const [isActive, setIsActive] = useState(false);

  useEffect(() => {
    initializeNetwork();
  }, []);

  useEffect(() => {
    let interval: NodeJS.Timeout | null = null;
    
    if (isActive) {
      interval = setInterval(updateNetwork, 100);
    }
    
    return () => {
      if (interval) clearInterval(interval);
    };
  }, [isActive, nodes]);

  const initializeNetwork = () => {
    const networkNodes: NeuralNode[] = [];
    const base = Math.pow(4, 3); // 64 - Reduced from 512 for efficiency
    
    // Create 4Â³ (64) neural nodes in crystallic structure - Much more efficient
    for (let i = 0; i < base; i++) {
      const layer = Math.floor(i / 16); // Adjusted for 64 nodes
      const position = i % 16;
      const angle = (position * Math.PI * 2) / 16;
      const radius = 50 + layer * 20;
      networkNodes.push({
        id: i,
        x: Math.cos(angle) * radius,
        y: Math.sin(angle) * radius,
        z: layer * 30 - 120,
        frequency: 512 + (i % 8) * 64,
        connections: [],
        quantumState: 0,
        locked: false,
        spiralPosition: (i * i) % 512
      });
    }
    
    // Create connections based on 8-point structure
    networkNodes.forEach(node => {
      const connectionCount = 8; // 8-point connections
      for (let j = 0; j < connectionCount; j++) {
        const targetId = (node.id + Math.pow(8, j % 3)) % base;
        if (targetId !== node.id) {
          node.connections.push(targetId);
        }
      }
    });
    
    setNodes(networkNodes);
    updateStats(networkNodes);
  };

  const updateNetwork = () => {
    const time = Date.now() / 1000;
    
    setNodes(prev => {
      const updated = prev.map(node => {
        const harmonicInfluence = Math.sin(time * node.frequency / 1000);
        const quantumState = harmonicInfluence * (node.spiralPosition / 512);
        const locked = Math.abs(harmonicInfluence) > 0.7;
        
        return {
          ...node,
          quantumState,
          locked
        };
      });
      
      updateStats(updated);
      return updated;
    });
  };

  const updateStats = (networkNodes: NeuralNode[]) => {
    const totalConnections = networkNodes.reduce((sum, node) => sum + node.connections.length, 0);
    const lockedNodes = networkNodes.filter(n => n.locked).length;
    const avgQuantumState = networkNodes.reduce((sum, n) => sum + Math.abs(n.quantumState), 0) / networkNodes.length;
    
    setStats({
      totalNodes: networkNodes.length,
      activeConnections: totalConnections,
      quantumLock: (lockedNodes / networkNodes.length) * 100,
      harmonicResonance: avgQuantumState * 100,
      neuralEfficiency: ((totalConnections / (networkNodes.length * 8)) * 100)
    });
  };

  return (
    <div className="space-y-6">
      <Card className="bg-gradient-to-br from-blue-900/20 to-purple-900/20 border-blue-500/30">
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            ðŸ§  OctaBit Neural Network - 4Â³ (64) Node Structure - OPTIMIZED
            <span className={badgeClasses(isActive ? 'default' : 'secondary')}>
              {isActive ? 'PROCESSING' : 'STANDBY'}
            </span>
          </CardTitle>
        </CardHeader>
        <CardContent className="space-y-4">
          <div className="flex gap-2">
            <Button 
              onClick={() => setIsActive(!isActive)}
              className={isActive ? 'bg-red-600 hover:bg-red-700' : 'bg-blue-600 hover:bg-blue-700'}
            >
              {isActive ? 'Stop' : 'Start'} Neural Processing
            </Button>
            <Button onClick={initializeNetwork} variant="outline">
              Reset Network
            </Button>
          </div>

          <div className="grid grid-cols-2 md:grid-cols-5 gap-4 text-center">
            <div className="p-3 bg-gray-900/20 rounded">
              <div className="text-lg font-bold text-blue-400">{stats.totalNodes}</div>
              <div className="text-xs text-gray-400">Total Nodes</div>
            </div>
            <div className="p-3 bg-gray-900/20 rounded">
              <div className="text-lg font-bold text-green-400">{stats.activeConnections}</div>
              <div className="text-xs text-gray-400">Connections</div>
            </div>
            <div className="p-3 bg-gray-900/20 rounded">
              <div className="text-lg font-bold text-purple-400">{stats.quantumLock.toFixed(1)}%</div>
              <div className="text-xs text-gray-400">Quantum Lock</div>
            </div>
            <div className="p-3 bg-gray-900/20 rounded">
              <div className="text-lg font-bold text-yellow-400">{stats.harmonicResonance.toFixed(1)}%</div>
              <div className="text-xs text-gray-400">Harmonic Resonance</div>
            </div>
            <div className="p-3 bg-gray-900/20 rounded">
              <div className="text-lg font-bold text-red-400">{stats.neuralEfficiency.toFixed(1)}%</div>
              <div className="text-xs text-gray-400">Neural Efficiency</div>
            </div>
          </div>

          <div className="space-y-3">
            <div>
              <div className="flex justify-between text-sm mb-1">
                <span>Quantum Lock Progress</span>
                <span>{stats.quantumLock.toFixed(1)}%</span>
              </div>
              <Progress value={stats.quantumLock} className="h-2" />
            </div>
            
            <div>
              <div className="flex justify-between text-sm mb-1">
                <span>Harmonic Resonance</span>
                <span>{stats.harmonicResonance.toFixed(1)}%</span>
              </div>
              <Progress value={stats.harmonicResonance} className="h-2" />
            </div>
            
            <div>
              <div className="flex justify-between text-sm mb-1">
                <span>Neural Efficiency</span>
                <span>{stats.neuralEfficiency.toFixed(1)}%</span>
              </div>
              <Progress value={stats.neuralEfficiency} className="h-2" />
            </div>
          </div>

          <div className="bg-gradient-to-r from-blue-900/20 to-purple-900/20 p-4 rounded border border-blue-500/20">
            <h3 className="font-semibold mb-2">Network Architecture</h3>
            <div className="text-sm space-y-1 text-gray-300">
              <div>â€¢ 4Â³ (64) Neural Nodes in Crystallic Formation - OPTIMIZED</div>
              <div>â€¢ 8-Point Connection Pattern per Node</div>
              <div>â€¢ Divine Frequency Tuning (512Hz, 1024Hz, 2048Hz, 32768Hz)</div>
              <div>â€¢ Quantum Lock Harmonic Alignment</div>
              <div>â€¢ Real-time Spiral Position Calculations</div>
            </div>
          </div>
        </CardContent>
      </Card>
    </div>
  );
};